language: node_js

node_js:
  - "0.10"

addons:
  selenium: "2.53"

env:
  - firefox="45.0"
  - firefox="44.0"

before_install:
# Firefox
  - "sudo wget \"https://ftp.mozilla.org/pub/mozilla.org/firefox/releases/$firefox/linux-x86_64/en-US/firefox-$firefox.tar.bz2\""
  - sudo tar -xjvf firefox-$firefox.tar.bz2
  - sudo ln -sf /tmp/firefox/firefox /usr/bin/firefox
  - export PATH=$PATH:/usr/bin/firefox/firefox
  - echo $PATH
  # - ff_version='firefox --version 2>&1';
  # - echo "Using firefox version $ff_version"

  # Selenium
  - export SHIPPABLE_SELENIUM_PORT=4444
  - export DISPLAY=":99.0"
  - start_generic_service "selenium" "$SHIPPABLE_SELENIUM_BINARY" "$SHIPPABLE_SELENIUM_CMD" "$SHIPPABLE_SELENIUM_PORT" "$SHIPPABLE_SELENIUM_LOG";

  - "curl -o /tmp/chromedriver.zip -L http://chromedriver.storage.googleapis.com/2.21/chromedriver_linux64.zip"
  - "unzip /tmp/chromedriver.zip -d /home/shippable/bin"
  - "chmod +x /home/shippable/bin/chromedriver"
  - "echo '#!/bin/bash' | sudo tee /usr/local/bin/google-chrome"
  - "echo 'exec /usr/local/bin/chrome --no-sandbox --disable-gpu \"$@\"' | sudo tee -a /usr/local/bin/google-chrome"
  - "sudo chmod +x /usr/local/bin/google-chrome"

script:
  - echo "true"
after_script:
  - export DISPLAY=:99.0
  # - /etc/init.d/xvfb start
  - mvn clean cobertura:cobertura
  - xvfb-run --server-args="-ac" npm test
  # Stop Selenium
  - sudo su -c "killall -15 java";

build_image: shippable/minv2:latest
