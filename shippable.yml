language: node_js

node_js:
  - "0.10"

addons:
  selenium: "2.53"

env:
  - firefox="45.0"
  - firefox="44.0"

before_install:
#xvfb
  - export DISPLAY=:99.0
  - /etc/init.d/xvfb start
 # Firefox
  - pushd /tmp
  - "sudo wget \"https://ftp.mozilla.org/pub/mozilla.org/firefox/releases/$firefox/linux-x86_64/en-US/firefox-$firefox.tar.bz2\""
  - sudo tar -xjvf firefox-$firefox.tar.bz2
  - sudo ln -sf /tmp/firefox/firefox /usr/bin/firefox
  - ff_version=`firefox --version`
  - echo "Using firefox version $ff_version"
  - popd
# Selenium
  - export SHIPPABLE_SELENIUM_PORT=4444
  - export DISPLAY=":99.0"
  - start_generic_service "selenium" "$SHIPPABLE_SELENIUM_BINARY" "$SHIPPABLE_SELENIUM_CMD" "$SHIPPABLE_SELENIUM_PORT" "$SHIPPABLE_SELENIUM_LOG";

# Chrome
#  - "curl -o /tmp/chromedriver.zip -L http://chromedriver.storage.googleapis.com/2.18/chromedriver_linux64.zip"
#  - "unzip /tmp/chromedriver.zip -d /home/shippable/bin"
#  - "chmod 777 /home/shippable/bin/chromedriver"

#  - "echo '#!/bin/bash' | sudo tee /usr/bin/google-chrome"
#  - "echo 'exec /usr/bin/chrome --no-sandbox --disable-gpu \"$@\"' | sudo tee -a /usr/local/bin/google-chrome"
#  - "sudo chmod 777 /usr/local/bin/google-chrome"
  #- sudo apt-get update && apt-get install -y libappindicator1 libnss3 --no-install-recommends
  - sudo apt-get update && apt-get install -y \
    ca-certificates \
    gconf-service \
    hicolor-icon-theme \
    libappindicator1 \
    libasound2 \
    libcanberra-gtk-module \
    libcurl3 \
    libexif-dev \
    libgconf-2-4 \
    libgl1-mesa-dri \
    libgl1-mesa-glx \
    libnspr4 \
    libnss3 \
    libpango1.0-0 \
    libv4l-0 \
    libxss1 \
    libxtst6 \
    fonts-liberation\
    xdg-utils \
    --no-install-recommends
  - sudo wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
  - sudo dpkg -i google-chrome-stable_current_amd64.deb
  - sudo apt-get install -y -f
  #- sudo apt-get install google-chrome-stable
  - sudo rm -f google-chrome-stable_current_amd64.deb

  - echo "================= Installing Chrome driver ==================="
  - sudo wget http://chromedriver.storage.googleapis.com/2.13/chromedriver_linux64.zip
  - sudo unzip chromedriver_linux64.zip && sudo rm -f chromedriver_linux64.zip
  - sudo mv chromedriver /usr/local/bin/chromedriver
  - sudo chmod a+x /usr/local/bin/chromedriver
  
  - sudo apt-get install chromium-browser;
  - sudo ln -s /usr/bin/chromium-browser /usr/bin/chrome;
  - sudo apt-get -f install;

  - wget -q -O- https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
  - sudo apt-get update
  - sudo apt-get install google-chrome-stable

script:
  - echo "true"
  - ls -al /usr/local/bin/
  - ls -al /home/shippable/bin/
after_script:
  - export DISPLAY=:99.0
  # - /etc/init.d/xvfb start
  #- mvn clean cobertura:cobertura
  - npm test
  # Stop Selenium
  - sudo su -c "killall -15 java";

build_image: shippable/minv2:latest
